findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
test$dbh2))))
}
View(test)
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
findDendroDBH(max(test$dbh2[1: i-1], na.rm = T), max(test$measure[1: i-1], na.rm=T), test$measure[[i]]),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
i=7
max(test$dbh2[1: i-1], na.rm = T
)
max(test$measure[1: i-1], na.rm=T)
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for (i in 2:nrow(test)){
test$dbh2 <-
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]), test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
mean(unlist(tapply(test$measure[1:i], test$dendroID[1:i], diff))),
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
test$dbh2))))
}
View(test)
mean(unlist(tapply(test$measure[1:i], test$dendroID[1:i], diff)))
i=2
mean(unlist(tapply(test$measure[1:i], test$dendroID[1:i], diff)))
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for (i in 2:nrow(test)){
test$dbh2 <-
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]), test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
mean(unlist(tapply(test$measure[1:i], test$dendroID[1:i], diff))) + test$dbh2[[i-1]],
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
test$dbh2))))
}
View(test)
test$dbh2[[i-1]]
test$dbh2[1] <- test$dbh[1]
i=2
test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
test$dbh2)
test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]])
objectiveFuncDendro= function(diameter2,diameter1,gap1,gap2){
if(gap1>diameter1) return(20)
if(gap2>diameter2) return(20)
delta=abs(diameter1 - diameter2 + (1/pi) * diameter2 * asin(gap2/diameter2) - (1/pi) * diameter1 * asin(gap1/diameter1))
return(return(delta))
}
findOneDendroDBH= function(dbh1,m1,m2,func=objectiveFuncDendro){
if(is.na(dbh1)|is.na(m1)|is.na(m2)|dbh1<=0) return(NA)
if(m2>0) upper=dbh1+m2
else upper=dbh1+1
if(m2<m1) lower=0
else lower=dbh1
result=optimize(f=func,interval=c(lower,upper),diameter1=dbh1,gap1=m1,gap2=m2)
return(result$minimum)
}
findDendroDBH= function(dbh1,m1,m2,func=objectiveFuncDendro){
records=max(length(dbh1),length(m1),length(m2))
if(length(dbh1)==1) dbh1=rep(dbh1,records)
if(length(m1)==1) m1=rep(m1,records)
if(length(m2)==1) m2=rep(m2,records)
dbh2=numeric()
for(i in 1:records) dbh2[i]=findOneDendroDBH(dbh1[i],m1[i],m2[i],func)
return(dbh2)
}
dendro_2017 <- read.csv("E:/Github_SCBI/Dendrobands/data/scbi.dendroAll_2017.csv")
intra <- dendro_2017[dendro_2017$intraannual==1, ]
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
View(test)
for (i in 2:nrow(test)){
test$dbh2 <-
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]), test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
mean(unlist(tapply(test$measure[1:i], test$dendroID[1:i], diff))) + test$dbh2[[i-1]],
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
test$dbh2))))
}
View(test)
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
findDendroDBH(max(test$dbh2[1: i-1], na.rm = T), max(test$measure[1: i-1], na.rm=T), test$measure[[i]]),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
i=7
max(test$dbh2[1: i-1], na.rm = T)
max(test$measure[1: i-1]
max(test$measure[1: i-1], na.rm=T)
max(test$measure[1: i-1]
max(test$measure[1: i-1], na.rm=T)
?diff
test$dbh2[1: i-1], na.rm = T
diff(test$dbh2[1: i-1], na.rm = T)
mean(diff(test$dbh2[1: i-1], na.rm = T))
View(test)
mean(diff(test$dbh2[1: i-1]), na.rm = T))
mean(diff(test$dbh2[1: i-1]), na.rm = T)
test$dbh2[[max(test$dbh2[1: i-1], na.rm = T)]]
test$dbh2[max(test$dbh2[1: i-1], na.rm = T)]
max(test$dbh2[1: i-1], na.rm = T)
max(test$dbh2[1: i-1], na.rm = T)
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T))
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
dendro_2017 <- read.csv("E:/Github_SCBI/Dendrobands/data/scbi.dendroAll_2017.csv")
intra <- dendro_2017[dendro_2017$intraannual==1, ]
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
objectiveFuncDendro= function(diameter2,diameter1,gap1,gap2){
if(gap1>diameter1) return(20)
if(gap2>diameter2) return(20)
delta=abs(diameter1 - diameter2 + (1/pi) * diameter2 * asin(gap2/diameter2) - (1/pi) * diameter1 * asin(gap1/diameter1))
return(return(delta))
}
findOneDendroDBH= function(dbh1,m1,m2,func=objectiveFuncDendro){
if(is.na(dbh1)|is.na(m1)|is.na(m2)|dbh1<=0) return(NA)
if(m2>0) upper=dbh1+m2
else upper=dbh1+1
if(m2<m1) lower=0
else lower=dbh1
result=optimize(f=func,interval=c(lower,upper),diameter1=dbh1,gap1=m1,gap2=m2)
return(result$minimum)
}
findDendroDBH= function(dbh1,m1,m2,func=objectiveFuncDendro){
records=max(length(dbh1),length(m1),length(m2))
if(length(dbh1)==1) dbh1=rep(dbh1,records)
if(length(m1)==1) m1=rep(m1,records)
if(length(m2)==1) m2=rep(m2,records)
dbh2=numeric()
for(i in 1:records) dbh2[i]=findOneDendroDBH(dbh1[i],m1[i],m2[i],func)
return(dbh2)
}
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
test <- intra[intra$tag==10671, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
View(test)
test <- intra[intra$tag==10671, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test[7,22] <- 853.4
View(test)
test[7:11,22] <- 853.4
View(test)
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
View(test)
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
##1d. troubleshoot with
dendro_2018 <- read.csv("E:/Github_SCBI/Dendrobands/data/scbi.dendroAll_2018.csv")
intra <- dendro_2018[dendro_2018$intraannual==1, ]
test <- intra[intra$tag==12025, ] #12025 has band replaced
View(test)
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2))))))
}
View(test)
max(test$dbh2[1: i-1], na.rm = T)
mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE)
diff(test$dbh2[1:(i-1)])
max(test$measure[1: i-1], na.rm = T)
na.locf(test$measure[[14]])
library(zoo)
install.packages("zoo")
library(zaoo)
library(zoo)
na.locf(test$measure[[14]])
na.locf(test$measure[i-1])
na.locf(test$measure[[i-1]])
test$measure[i-1]
na.locf(test$measure)
na.locf(test$measure[1:i-1])
na.locf(test$measure[i-1])
?na.locf
tail(na.locf(test$measure[1:i-1]))
tail(na.locf(test$measure[1:i-1]), n=1)
##1d. troubleshoot with
dendro_2018 <- read.csv("E:/Github_SCBI/Dendrobands/data/scbi.dendroAll_2018.csv")
intra <- dendro_2018[dendro_2018$intraannual==1, ]
test <- intra[intra$tag==12025, ] #12025 has band replaced
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & !is.na(test$dbh2[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & is.na(test$dbh2[[i-1]]),
findDendroDBH(max(test$dbh2[1: i-1], na.rm = T), tail(na.locf(test$measure[1:i-1]), n=1), test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=T),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2)))))))
}
View(test)
dendro_2017 <- read.csv("E:/Github_SCBI/Dendrobands/data/scbi.dendroAll_2017.csv")
intra <- dendro_2017[dendro_2017$intraannual==1, ]
test <- intra[intra$tag==60459, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & !is.na(test$dbh2[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & is.na(test$dbh2[[i-1]]),
findDendroDBH(max(test$dbh2[1: i-1], na.rm = T), tail(na.locf(test$measure[1:i-1]), n=1), test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=T),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2)))))))
}
View(test)
test <- intra[intra$tag==10671, ] #60459 has band replaced but with NAs for a few measurements. The following code should be tried with 10671 as well.
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & !is.na(test$dbh2[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & is.na(test$dbh2[[i-1]]),
findDendroDBH(max(test$dbh2[1: i-1], na.rm = T), tail(na.locf(test$measure[1:i-1]), n=1), test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=T),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2)))))))
}
View(test)
i=5
tail(na.locf(test$dbh2[1:i-1]), n=1)
intra <- dendro_2018[dendro_2018$intraannual==1, ]
test <- intra[intra$tag==12025, ] #12025 has band replaced
test$dbh2 <- NA
test$dbh2[1] <- test$dbh[1]
for(i in 2:nrow(test)) {
test$dbh2[[i]] <-
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & !is.na(test$dbh2[[i-1]]),
findDendroDBH(test$dbh2[[i-1]], test$measure[[i-1]], test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & !is.na(test$measure[[i]]) & is.na(test$dbh2[[i-1]]),
findDendroDBH(tail(na.locf(test$dbh2[1:i-1]), n=1), tail(na.locf(test$measure[1:i-1]), n=1), test$measure[[i]]),
ifelse(test$new.band[[i]] == 0 & is.na(test$measure[[i]]),
NA,
ifelse(test$new.band[[i]]==1 & !is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[[i]],
ifelse(test$new.band[[i]] == 1 & !is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
sum(mean(diff(test$dbh2[1: i-1]), na.rm = T), max(test$dbh2[1: i-1], na.rm = T)),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & identical(test$dbh[[i]], test$dbh[[i-1]]),
max(test$dbh2[1: i-1], na.rm = T) + mean(diff(test$dbh2[1:(i-1)]), na.rm=T),
ifelse(test$new.band[[i]] == 1 & is.na(test$measure[[i]]) & !identical(test$dbh[[i]], test$dbh[[i-1]]),
test$dbh[i] + mean(diff(test$dbh2[1:(i-1)]), na.rm=TRUE),
test$dbh2)))))))
}
View(test)
setwd("C:/Users/mcgregori/Dropbox (Smithsonian)/Github_Ian/Dendrobands/data")
dirs <- dir("C:/Users/mcgregori/Dropbox (Smithsonian)/Github_Ian/Dendrobands/data", pattern="_201[0-8]*.csv")
years <- c(2010:2018)
#1a. this loop breaks up each year's dendroband trees into separate dataframes by stemID
all_years <- list()
for (k in seq(along=dirs)){
file <- dirs[[k]]
yr <- read.csv(file)
yr_intra <- yr[yr$intraannual==1, ]
all_years[[k]] <- split(yr_intra, yr_intra$stemID)
#  if (file == dirs[[1]]){
#   all_years[[k]] <- split(yr, yr$stemID)
#  }
#  else{
#    all_years[[k]] <- split(yr_intra, yr_intra$stemID)
#  }
}
tent_name <- paste0("trees", sep="_", years)
names(all_years) <- tent_name
#the below loop takes all the unique stemIDs from each year and rbinds them.
all_stems <- list()
for(stemID in sort(unique(unlist(sapply(all_years, names))))) {
all_stems[[paste0("stemID_", stemID)]] <-  do.call(rbind, lapply(years, function(year) all_years[[paste0("trees", sep="_", year)]][[stemID]]))
}
#sort(unique(unlist(sapply(all_years, names)))) -> an explainer:
#sapply says find all the names within all_years
#unlist says take all those names (all those stemIDS) and dump them all together
#unique gets rid of the duplicates, and sort sorts them
#need to call in Condit's functions (also saved in separate R code) for the next bit
objectiveFuncDendro= function(diameter2,diameter1,gap1,gap2){
if(gap1>diameter1) return(20)
if(gap2>diameter2) return(20)
delta=abs(diameter1 - diameter2 + (1/pi) * diameter2 * asin(gap2/diameter2) - (1/pi) * diameter1 * asin(gap1/diameter1))
return(return(delta))
}
findOneDendroDBH= function(dbh1,m1,m2,func=objectiveFuncDendro){
if(is.na(dbh1)|is.na(m1)|is.na(m2)|dbh1<=0) return(NA)
if(m2>0) upper=dbh1+m2
else upper=dbh1+1
if(m2<m1) lower=0
else lower=dbh1
result=optimize(f=func,interval=c(lower,upper),diameter1=dbh1,gap1=m1,gap2=m2)
return(result$minimum)
}
findDendroDBH= function(dbh1,m1,m2,func=objectiveFuncDendro){
records=max(length(dbh1),length(m1),length(m2))
if(length(dbh1)==1) dbh1=rep(dbh1,records)
if(length(m1)==1) m1=rep(m1,records)
if(length(m2)==1) m2=rep(m2,records)
dbh2=numeric()
for(i in 1:records) dbh2[i]=findOneDendroDBH(dbh1[i],m1[i],m2[i],func)
return(dbh2)
}
library(zoo)
for(stems in names(all_stems)) {
tree.n <- all_stems[[stems]]
tree.n$dbh2 <- NA
tree.n$dbh2[1] <- tree.n$dbh[1]
tree.n$dbh2 <- as.numeric(tree.n$dbh2)
tree.n$measure <- as.numeric(tree.n$measure)
tree.n$dbh <- as.numeric(tree.n$dbh)
q <- mean(unlist(tapply(tree.n$measure, tree.n$dendroID, diff)), na.rm=TRUE)
for(i in 2:(nrow(tree.n))){
tree.n$dbh2[[i]] <-
ifelse(tree.n$new.band[[i]] == 0 & tree.n$survey.ID[[i]] == 2014.01 & !identical(tree.n$dbh[[i]], tree.n$dbh[[i-1]]),
tree.n$dbh[[i]],
ifelse(tree.n$new.band[[i]] == 0 & !is.na(tree.n$measure[[i]]) & !is.na(tree.n$dbh2[[i-1]]),
findDendroDBH(tree.n$dbh2[[i-1]], tree.n$measure[[i-1]], tree.n$measure[[i]]),
ifelse(tree.n$new.band[[i]] == 0 & !is.na(tree.n$measure[[i]]) & is.na(tree.n$dbh2[[i-1]]),
findDendroDBH(tail(na.locf(tree.n$dbh2[1:i-1]), n=1), tail(na.locf(tree.n$measure[1:i-1]), n=1), tree.n$measure[[i]]),
ifelse(tree.n$new.band[[i]] == 0 & is.na(tree.n$measure[[i]]), NA,
ifelse(tree.n$new.band[[i]]==1 & !is.na(tree.n$measure[[i]]) & !identical(tree.n$dbh[[i]], tree.n$dbh[[i-1]]),
tree.n$dbh[[i]],
ifelse(tree.n$new.band[[i]] == 1 & !is.na(tree.n$measure[[i]]) & identical(tree.n$dbh[[i]], tree.n$dbh[[i-1]]),
max(tree.n$dbh2[1: i-1], na.rm = T) + mean(diff(tree.n$dbh2[1: i-1]), na.rm = T),
ifelse(tree.n$new.band[[i]] == 1 & is.na(tree.n$measure[[i]]) & identical(tree.n$dbh[[i]], tree.n$dbh[[i-1]]),
max(tree.n$dbh2[1: i-1], na.rm = T) + mean(diff(tree.n$dbh2[1:(i-1)]), na.rm=T),
ifelse(tree.n$new.band[[i]] == 1 & is.na(tree.n$measure[[i]]) & !identical(tree.n$dbh[[i]], tree.n$dbh[[i-1]]),
tree.n$dbh[i] + mean(diff(tree.n$dbh2[1:(i-1)]), na.rm=TRUE),
tree.n$dbh2))))))))
}
all_stems[[stems]] <- tree.n
}
View(all_stems$stemID_10045)
w <- tree.n$dbh[tree.n$survey.ID == c(2010.01:2013.16)]
w <- tree.n$dbh[tree.n$survey.ID %in% c(2010.01:2013.16)]
w <- tree.n$dbh[tree.n$survey.ID %in% c(2010.01:2013.16), ]
w <- tree.n$dbh[, tree.n$survey.ID %in% c(2010.01:2013.16)]
w <- tree.n$dbh[ ,tree.n$survey.ID %in% c(2010.01:2013.16)]
?identical
w <- all_stems$stemID_10045
tail(w$dbh2)
tail(w$dbh2, n=1)
tail(w$dbh2, n=2)
?diff
